<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Narraverso</title>
    <link rel="stylesheet" href="css/estiloperfil.css">
    <script src="menu.js"></script>
</head>
<body>
   <?php
session_start();
if (!isset($_SESSION['id'])) {
    die("Sessão não iniciada. Faça login primeiro.");
}

require("tccbdconnecta.php");

$id = $_SESSION['id'];

if (!$conn) {
    die("Erro na conexão com o banco de dados: " . mysqli_error($conn));
}

$sql = "SELECT fotoPerfil, login, seguidores, seguindo, publicacoes, descricao FROM tcc_pessoa WHERE id = $id";
$resultado = mysqli_query($conn, $sql);

if (!$resultado) {
    die("Erro na consulta SQL: " . mysqli_error($conn));
}

if (mysqli_num_rows($resultado) > 0) {
    $dados = mysqli_fetch_assoc($resultado);
    $fotoPerfil = !empty($dados['fotoPerfil']) ? $dados['fotoPerfil'] : 'imagens/login-bege.png';
    $login = $dados['login'];
    $seguidores = $dados['seguidores'];
    $seguindo = $dados['seguindo'];
    $publicacoes = $dados['publicacoes'];
    $descricao = $dados['descricao'];
} else {
    die("Usuário não encontrado.");
}

if ($seguidores == 0) $seguidores = 0;
if ($seguindo == 0) $seguindo = 0;
if ($publicacoes == 0) $publicacoes = 0;



//Verificação se há obras
if (!$conn) {
    die("Erro com a conexão com o banco de dados: " .mysqli_connect_error());
}

$categoria = isset($_GET['categoria']) ? mysqli_real_escape_string($conn, $_GET['categoria']) : '';

if (empty($categoria)) {
//verifica qual categoria tem as obras
$categorias = ['filme', 'serie', 'livro'];

foreach ($categorias as $cat) {
$sqlCheck = "SELECT 1 FROM tcc_obra WHERE categoria = '$cat' LIMIT 1";
$resultadoCheck = mysqli_query($conn, $sqlCheck);

    if ($resultadoCheck && mysqli_num_rows($resultadoCheck) > 0) {
        header("Location: ?categoria=$cat");
        exit;
    }
}

//Se nenhuma categoria tiver obras
$categoria = 'filme'; 
}
?>
    <header>

        <nav class="nav-bar-principal">
            <div class="nav-list-icone-menu">
                <ul>
                    <li class="nav-item">
                        <a href="#" id="menu-toggle" class="nav-link">
                            <img src="imagens/menu-bege.png" alt="menu" />
                        </a>
                    </li>
                </ul>
            </div>

            <div id="menu" class="nav-list-menu">
                <ul>
                    <li class="nav-item"><a href="index.php" class="nav-link-casa"><img src="imagens/casa-bege.png" alt="casa">      Página Inicial</a></li>
                    <li class="nav-item"><a href="quemSomos.php" class="nav-link"><img src="imagens/quem-somos-bege.png" alt="quem-somos">  Quem Somos</a></li>
                    <li class="nav-item"><a href="pesquisa.php" class="nav-link"><img src="imagens/pesquisa-bege.png" alt="pesquisa">  Pesquisar</a></li>
                    <li class="nav-item"><a href="favorito.php" class="nav-link"><img src="imagens/coracao-bege.png" alt="Favoritos">  Favoritos</a></li>
                    <li class="nav-item"><a href="cadObra01.php" class="nav-link"><img src="imagens/mais-bege.png" alt="mais">  Cadastrar novas obras</a></li>
                    <li class="nav-item"><a href="configuracoes.php" class="nav-link"><img src="imagens/configuracoes-bege.png" alt="configuracao">  Configurações</a></li>
                </ul>
            </div>
        </nav>

        <nav class="nav-bar-logo">
        <div class="nav-list-logo">
                <ul>
                    <!-- Ícone 6: text-narraverso -->
                    <li class="nav-item">
                        <a  class="nav-link-text-narraverso">
                            <img src="imagens/text-narraverso.png" alt="text-narraverso"/>
                        </a>
                    </li>
                </ul>
            </div>
            </nav>


            <nav class="nav-bar-sino">
            <div class="nav-list-sino">
                <ul>
                    <!-- Ícone 7: Sino -->
                    <li class="nav-item">
                        <a href="#" class="nav-link-sino">
                            <img src="imagens/sino-bege.png" alt="Sino"/>
                        </a>
                    </li>
                </ul>
            </div>
            </nav>

            <nav class="nav-bar-login">
            <div class="nav-list-login">
                <ul>
                    <!-- Ícone 7: Contato -->
                    <li class="nav-item">
                        <a href="#" class="nav-link-login">
                            <img src="imagens/usuario-verde.png" alt="Usuario"/>
                        </a>
                    </li>
                </ul>
            </div>
            </nav>


    

        
        <div class="cadastrar-container">

            <div class="perfil-container">
                <div class="perfil-foto">
                    <label class="fotoPerfil" tabindex="0">
                        <span class="fotoPerfil-image">
                            <img id="preview" src="<?php echo empty($fotoPerfil) ? 'imagens/login-bege.png' : $fotoPerfil; ?>" alt="Foto de Perfil">
                        </span>
                        <input type="file" name="fotoPerfil-name" value="<?php echo $fotoPerfil; ?>" accept="image/*" class="fotoPerfil-input" onchange="previewImage(event)" disabled /> 
                    </label>
                    <button type="button" class="edit-button" onclick="window.location.href='cadastroUpdate01.php?id=<?php echo $id; ?>'" >Editar perfil</button>
                </div>
            
                <div class="nav-list-informacoes">
                    <div class="nav-list-usuario">
                        <label class="login-usuario"><?php echo $login; ?>Isabelly_barros</label>
                    </div>

                    <div class="nav-list-dados">
                        <a href="#" class="numero-seguidores" id="numero-seguidores">Seguidores:<br> <?php echo $seguidores; ?></a>
                        <a href="#" class="numero-seguindo" id="numero-seguindo">Seguindo:<br> <?php echo $seguindo; ?></a>
                        <a href="#" class="numero-publicacao">Publicações:<br> <?php echo $publicacoes; ?></a>
                    </div>

                    <div class="nav-list-descricao">
                        <label class="texto-descricao"><?php echo $descricao; ?>blablablablablablbabla</label>
                    </div>

                    <div class="icone-container">
                        <?php
                            function getIcon($cat, $categoriaAtual) {
                                $cor = $cat === $categoriaAtual ? 'verde' : 'vermelho';
                                return "imagens/{$cat}-{$cor}.png";
                        }
                        ?>
                        <a href="?login=<?= urlencode($login) ?>&categoria=filme" class="icone-filme"><img src="<?php echo getIcon('filme', $categoria);?>" alt="filme"></a>
                        <a href="?login=<?= urlencode($login) ?>&categoria=serie" class="icone-serie"><img src="<?php echo getIcon('serie', $categoria);?>" alt="serie"></a>
                        <a href="?login=<?= urlencode($login) ?>&categoria=livro" class="icone-livro"><img src="<?php echo getIcon('livro', $categoria);?>" alt="livro"></a>
                    </div>

                    <!--Mostrar as obras-->
                    <div class="container-principal-perfil" id="container-principal-perfil">
                        <ul class="obras-perfil" id="obras-perfil">
                            <?php

                                $sql = "SELECT nome, fotoPerfil, categoria, genero FROM tcc_obra WHERE categoria = '$categoria' AND idUsuario = $id";

                                $resultado = mysqli_query($conn, $sql);

                                if (!$resultado) {
                                    die("Erro ao fazer a consulta SQL: " .mysqli_connect_error($conn));
                                }

                                if (mysqli_num_rows($resultado) > 0) { //quatas linhas retornou da nossa pesquisa
                                    while ($dados = mysqli_fetch_assoc($resultado)){ //mostra resultado da pesquisa 
                                        $fotoObra = !empty($dados['fotoPerfil']) ? $dados['fotoPerfil'] : 'imagens/imagem-obras.png';
                                        $nome = $dados['nome'];
                                        $categoria = $dados['categoria'];
                                        $genero = $dados['genero'];

                                        echo '<li class="obras" data-tipo="' . $categoria .'"  data-genero="' . $genero . '">
                                        <div class="obras-image">
                                            <img id="preview-obra" src="' . $fotoObra . '" alt="Imagem da obra">
                                        </div>
                                        <div class="conteudo-obras">
                                            <h2 class="conteudo-nome">
                                                '. $nome .'
                                            </h2>
                                        </div>
                                    </li>';
                                    } //enquanto houver resultado aparece
                                } else {
                                    echo '<li id="sem_resultado">
                                        <p>Nenhuma obra encontrada!</p>
                                    </li>';
                                }
                            ?>
                        </ul>    
                    </div>
                </div>
            </div>

        </div>



        <div class="seguidores-overlay">
            <div class="container-principal-seguidores">
                <form method="POST">
                    <div class="container-pesquisa">
                        <div class="pesquisa-imagem">
                            <img src="imagens/pesquisa-container.png" alt="Ícone de pesquisa">
                        </div>
                        <input type="text" class="barra-pesquisa" id="barra-pesquisa" name="pesquisa" placeholder="Pesquise obras, usuários (obrigatório @ antes)...">
                    </div>
                </form>
                <?php echo '<h2 class="contas-titulo" id="contas-titulo"><br>Seguidores:</h2>'; ?>
                    <ul class="container-seguidores">
                        <?php

                        $pesquisa = isset($_POST['pesquisa']) ? $_POST['pesquisa'] : '';

                        $pesquisa = mysqli_real_escape_string($conn, $pesquisa);

                        $sql2 = "SELECT p.fotoPerfil, p.login
                        FROM tcc_seguidores s
                        JOIN tcc_pessoa p ON p.id = s.seguidor_id
                        WHERE s.seguido_id = $id AND p.login LIKE '$pesquisa%'";

                        $stmt2 = mysqli_query($conn, $sql2);

                        if (!$stmt2) {
                            die("Erro ao fazer a consulta SQL: " .mysqli_error($conn));
                        }



                        if (mysqli_num_rows($stmt2) > 0) { //quatas linhas retornou da nossa pesquisa
                            while ($dados = mysqli_fetch_assoc($stmt2)){ //mostra resultado da pesquisa 
                                $fotoPessoa = !empty($dados['fotoPerfil']) ? $dados['fotoPerfil'] : 'imagens/imagem-obras.png';
                                $login = $dados['login'];


                                    echo '<li class="pessoas">';

                                        echo'<a href="perfil_usuario.php?login=' . urlencode($login) . '">';


                                        echo '<div class="pessoas-image">
                                            <img id="pessoa-preview" src="' . $fotoPessoa . '" alt="Imagem da Usuario">
                                        </div>
                                    </a>
                                        <div class="conteudo-obras">
                                            <h2 class="conteudo-nome">
                                                '. $login .'
                                            </h2>
                                        </div>
                                </li>';

                            } //enquanto houver resultado aparece
                        }
                            


                        

                        
                    ?>
                    <a class="fechar-seguidores">Voltar</a>
                </ul>


                <?php echo '<h2 class="contas-titulo" id="contas-titulo"><br>Seguindo:</h2>'; ?>
                    <ul class="container-seguindo">
                        <?php

                        $pesquisa = isset($_POST['pesquisa']) ? $_POST['pesquisa'] : '';


                        $pesquisa = mysqli_real_escape_string($conn, $pesquisa);

                        $sql3 = "SELECT p.fotoPerfil, p.login
                        FROM tcc_seguidores s
                        JOIN tcc_pessoa p ON p.id = s.seguido_id
                        WHERE s.seguidor_id = $id AND p.login LIKE '$pesquisa%'";

                        $stmt3 = mysqli_query($conn, $sql3);

                        if (!$stmt3) {
                            die("Erro ao fazer a consulta SQL: " .mysqli_error($conn));
                        }



                        if (mysqli_num_rows($stmt3) > 0) { //quatas linhas retornou da nossa pesquisa
                            while ($dados = mysqli_fetch_assoc($stmt3)){ //mostra resultado da pesquisa 
                                $fotoPessoa = !empty($dados['fotoPerfil']) ? $dados['fotoPerfil'] : 'imagens/imagem-obras.png';
                                $login = $dados['login'];


                                    echo '<li class="pessoas">';

                                        echo'<a href="perfil_usuario.php?login=' . urlencode($login) . '">';


                                        echo '<div class="pessoas-image">
                                            <img id="pessoa-preview" src="' . $fotoPessoa . '" alt="Imagem da Usuario">
                                        </div>
                                    </a>
                                        <div class="conteudo-obras">
                                            <h2 class="conteudo-nome">
                                                '. $login .'
                                            </h2>
                                        </div>
                                </li>';

                            } //enquanto houver resultado aparece
                        } 

                        echo '<li class= "sem_resultado" id="sem_resultado">
                            <p>Nenhum resultado encontrado!</p>
                        </li>';


                        mysqli_close($conn);
                        
                    ?>
                    <a class="fechar-seguidores">Voltar</a>
                </ul>

            </div>
        </div>
        
        

        <div id="trilho"></div> <!--Para funcionar modo escuro-->

                    
    </header>


   
</body>
</html>
